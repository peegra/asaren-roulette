<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- style.css を確実に読み込む -->
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Nico+Moji&family=Rounded+Mplus+1c:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="center-container">
    <!-- タイトル・ロゴ・コメント -->
    <div class="header">
      <img src="logo.png" alt="ロゴ" class="logo">
      <h1 class="title">ASARENルーレット</h1>
      <p class="comment">今日のメニューは何かな？ルーレットを回してみよう！</p>
    </div>
    <!-- 追加: メニュー選択ボタン -->
    <div class="action-buttons">
      <button id="btn-shoot" class="action-btn">シュート</button>
      <button id="btn-juggle" class="action-btn">リフティング</button>
      <button id="btn-tech" class="action-btn">テクニック</button>
      <button id="btn-beginner" class="action-btn">ビギナー</button>
    </div>
    <div class="canvas-area">
      <canvas id="canvas" width="1000" height="1000"></canvas>
    </div>
    <div id="arrow">&#x25B2;</div>
    <div id="result"></div>
    <button id="spin" class="rich-btn">
      <span class="btn-text">挑戦！</span>
    </button>
    <!-- 更新ボタンを削除しました -->
    <audio id="spin-audio" src="spin.mp3"></audio>
    <audio id="win-audio1" src="win1.mp3"></audio>
    <audio id="win-audio2" src="win2.mp3"></audio>
    <audio id="win-audio3" src="win3.mp3"></audio>
  </div>
  <!-- LINE LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
// ====== LIFF 初期化 ======
// ミニアプリが動かないので削除
 const liffId = ""; // ここにLIFF IDを入れる

// LIFFを初期化して、未ログインならログイン画面へ
liff.init({ liffId }).then(() => {
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: window.location.href });
  }
});

// ====== ルーレット設定 ======
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// ルーレットの項目と色
let items = []; // スプレッドシートから読み込むので空にしておく

// スプレッドシート設定（必要に応じて gid を変更）
const SHEET_ID = '1OYx8j7IMjg1_rbSd8nq8Hbidz601uNWiEYFrIelEGR4';
const SHEET_GID = '233683813'; // 「ルーレット」シートの gid
let colors = [];
let angle = 0; // ルーレットの初期角度

// スプレッドシート（CSV）から項目を読み込む
async function loadItemsFromSheet() {
  try {
    // gviz endpoint を使いタイムスタンプで強制再取得
    const baseUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GID}`;
    const url = `${baseUrl}&t=${Date.now()}`;
    console.log('fetching sheet url=', url);
    const res = await fetch(url, {
      method: 'GET',
      cache: 'no-store',
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        Pragma: 'no-cache'
      }
    });

    if (!res.ok) throw new Error('スプレッドシート取得失敗: ' + res.status);

    const text = await res.text();
    console.log('loadItemsFromSheet: fetched length=', text.length);
    // デバッグ: 先頭をログに出す（長すぎないよう）
    console.log('loadItemsFromSheet: sample=', text.slice(0, 500).replace(/\n/g,'\\n'));
    const rows = text.split(/\r?\n/).map(r => r.trim()).filter(r => r.length > 0);

    // CSV の各行から「A列（1列目）」だけを取り出す
    // 1列目は引用符で囲まれている場合や "" エスケープにも対応
    items = rows.map(line => {
      const m = line.match(/^("(?:[^"]|"")*"|[^,]*)/);
      let first = m ? m[1] : '';
      if (!first) return '';
      if (first.startsWith('"') && first.endsWith('"')) {
        first = first.slice(1, -1).replace(/""/g, '"');
      }
      return first.trim();
    }).filter(v => v.length > 0); // 空行除去

    console.log('loadItemsFromSheet: items =', items);

    // 固定で20分割の虹色パレットを作り、items に対して循環割当する
    const palette20 = Array.from({ length: 20 }, (_, j) => {
      const hue = Math.round((j / 20) * 360);
      return `hsl(${hue}, 90%, 55%)`;
    });
    colors = items.map((_, i) => palette20[i % 20]);

    // 描画（読み込み後に初回描画）
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawRoulette();
  } catch (e) {
    console.error('loadItemsFromSheet error:', e);
    // フォールバックの項目（既存の固定リストを入れるなど）
    items = [
      "足足頭頭25m","世界逆一周","3タッチ回転3回","胸キャッチ2回","JUMPトラップ5m x 5回",
      "アラウンドザワールド","インインアウトアウト 10周","右肩 6回","アウト乗せ 3回","背中キャッチ 2回",
      "右ちょん10m","頭のみ10m","足乗せ両足背中キャッチ","足足胸JUMP 25m","たまごちゃん 3m",
      "足足肩シュート","ももダッシュ25m","ショルダーロール","そうまリフティング 25m","地面バウンド3種類"
    ];
    const palette20 = Array.from({ length: 20 }, (_, j) => {
      const hue = Math.round((j / 20) * 360);
      return `hsl(${hue}, 90%, 55%)`;
    });
    colors = items.map((_, i) => palette20[i % 20]);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawRoulette();
  }
}

// ====== 音声設定 ======
const spinAudio = document.getElementById('spin-audio'); // 回転中の音
const winAudio1 = document.getElementById('win-audio1'); // 当たり音1（80%）
const winAudio2 = document.getElementById('win-audio2'); // 当たり音2（10%）
const winAudio3 = document.getElementById('win-audio3'); // 当たり音3（10%）

// ====== ルーレット描画関数 ======
function drawRoulette() {
  const arc = (2 * Math.PI) / items.length;
  // 6時方向（下）を0ラジアンにする
  const base = angle;
  for (let i = 0; i < items.length; i++) {
    ctx.beginPath();
    ctx.moveTo(500, 500);
    ctx.fillStyle = colors[i];
    ctx.arc(500, 500, 500, base + i * arc, base + (i + 1) * arc);
    ctx.fill();

    // 文字の描画
    ctx.save();
    ctx.translate(500, 500);
    ctx.rotate(base + (i + 0.5) * arc);
    ctx.fillStyle = "#000";
    ctx.textAlign = "right";
    ctx.font = "32px sans-serif";
    ctx.fillText(items[i], 490, 10);
    ctx.restore();
  }
}

function getResultItem() {
  const arc = (2 * Math.PI) / items.length;
  // 6時方向（下）はcanvas基準でMath.PI/2ラジアン
  // 現在のangle分だけ回転しているので、実際の6時方向の角度は
  // (Math.PI/2 - angle) を 0～2πに正規化
  let pointer = (Math.PI / 2 - angle + 2 * Math.PI) % (2 * Math.PI);

  // どの扇形に含まれるか判定
  for (let i = 0; i < items.length; i++) {
    let start = (i * arc) % (2 * Math.PI);
    let end = ((i + 1) * arc) % (2 * Math.PI);
    // 扇形が0をまたぐ場合も考慮
    if (start < end) {
      if (pointer >= start && pointer < end) return items[i];
    } else {
      if (pointer >= start || pointer < end) return items[i];
    }
  }
  // 念のため
  return items[0];
}

// ====== ルーレット回転処理 ======
let spinning = false; // 回転中フラグ

function spinRoulette() {
  if (spinning) return; // 連打防止
  spinning = true;
  document.getElementById('spin').disabled = true; // ボタン無効化

  // 回転音を再生
  spinAudio.currentTime = 0;
  spinAudio.play();

  // 回転音の長さ（秒）を取得
  const spinDuration = spinAudio.duration || 2; // durationが0の場合は2秒に仮設定

  // アニメーション設定
  const fps = 60;
  const totalFrames = Math.floor(spinDuration * fps);
  let currentFrame = 0;
  const startAngle = angle;
  // 最終的にランダムな位置で止める
  const endAngle = startAngle + Math.PI * 4 + Math.random() * 2 * Math.PI; // 4回転＋ランダム

  const interval = setInterval(() => {
    currentFrame++;
    // イージングで減速
    const t = currentFrame / totalFrames;
    // easeOutCubic
    const eased = 1 - Math.pow(1 - t, 3);
    angle = startAngle + (endAngle - startAngle) * eased;

    ctx.clearRect(0, 0, 1000, 1000);
    drawRoulette();

    if (currentFrame >= totalFrames) {
      clearInterval(interval);
      spinAudio.pause();
      spinAudio.currentTime = 0;

      // ランダムで当選音を選択
      const r = Math.random();
      if (r < 0.7) {
        winAudio1.currentTime = 0;
        winAudio1.play();
      } else if (r < 0.85) {
        winAudio2.currentTime = 0;
        winAudio2.play();
      } else {
        winAudio3.currentTime = 0;
        winAudio3.play();
      }

      spinning = false;
      document.getElementById('spin').disabled = false;

      // 角度を0～2πに正規化
      angle = (angle % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);

      // 当選項目を表示
      const resultItem = getResultItem();
      document.getElementById('result').textContent = resultItem;
    }
  }, 1000 / fps);
}

// ====== 初期描画 ======
// drawRoulette();
loadItemsFromSheet();

let audioUnlocked = false;

document.getElementById('spin').addEventListener('click', async function() {
  if (!audioUnlocked) {
    // win系だけプリロード（無音再生）
    await Promise.all([winAudio1, winAudio2, winAudio3].map(audio => {
      return new Promise(resolve => {
        try {
          audio.muted = true;
          audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
            audio.muted = false;
            resolve();
          }).catch(() => resolve());
        } catch(e) { resolve(); }
      });
    }));
    audioUnlocked = true;
  }

  document.getElementById('result').textContent = ""; // 回すたびにリセット
  spinRoulette();
});

// 更新ボタンとそのイベントリスナーを削除しました
</script>

<script>
// DOM が準備できたらボタンにクラスを再付与して強制リフロー
window.addEventListener('DOMContentLoaded', () => {
  const btns = document.querySelectorAll('.action-btn, .rich-btn, #spin');
  btns.forEach(b => {
    // 再付与で CSS の優先度や継承のズレを解消
    b.classList.remove('action-btn','rich-btn');
    void b.offsetWidth; // 強制リフロー
    b.classList.add('action-btn','rich-btn');
    // もし個別のIDで使っている場合は確実に付与
    if (b.id === 'spin') b.classList.add('rich-btn');
  });

  // Web フォント遅延読み込み対策（あれば）
  document.fonts && document.fonts.ready.then(() => {
    // フォント読み込み後に再描画が必要ならここで再描画処理を呼ぶ
    if (typeof drawRoulette === 'function') {
      drawRoulette();
    }
  });
});
</script>
</body>
</html>