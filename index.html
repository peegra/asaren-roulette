<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- style.css を確実に読み込む -->
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Nico+Moji&family=Rounded+Mplus+1c:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="center-container">
    <!-- タイトル・ロゴ・コメント -->
    <div class="header">
      <img src="logo.png" alt="ロゴ" class="logo">
      <h1 class="title">ASARENルーレット</h1>
      <p class="comment">今日のメニューは何かな？ルーレットを回してみよう！</p>
    </div>
    <!-- 追加: メニュー選択ボタン -->
    <div class="action-buttons">
      <button id="btn-shoot" class="action-btn">シュート</button>
      <button id="btn-juggle" class="action-btn">リフティング</button>
      <button id="btn-tech" class="action-btn">テクニック</button>
      <button id="btn-beginner" class="action-btn">ビギナー</button>
    </div>
    <div class="canvas-area">
      <canvas id="canvas" width="1000" height="1000"></canvas>
    </div>
    <div id="arrow">&#x25B2;</div>
    <div id="result"></div>
    <button id="spin" class="rich-btn">
      <span class="btn-text">挑戦！</span>
    </button>
    <!-- 更新ボタンを削除しました -->
    <audio id="spin-audio" src="spin.mp3"></audio>
    <audio id="win-audio1" src="win1.mp3"></audio>
    <audio id="win-audio2" src="win2.mp3"></audio>
    <audio id="win-audio3" src="win3.mp3"></audio>
  </div>
  <!-- LINE LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
// ====== LIFF 初期化 ======
// ミニアプリが動かないので削除
 const liffId = ""; // ここにLIFF IDを入れる

// LIFFを初期化して、未ログインならログイン画面へ
liff.init({ liffId }).then(() => {
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: window.location.href });
  }
});

// ====== ルーレット設定 ======
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// ルーレットの項目と色
let items = []; // スプレッドシートから読み込むので空にしておく

// スプレッドシート設定（必要に応じて gid を変更）
const SHEET_ID = '1OYx8j7IMjg1_rbSd8nq8Hbidz601uNWiEYFrIelEGR4';
const SHEET_GID = '233683813'; // 「ルーレット」シートの gid
let colors = [];
let angle = 0; // ルーレットの初期角度

// スプレッドシート（CSV）から項目を読み込む（列指定対応）
async function loadItemsFromSheet(column = 'A') {
  try {
    const colMap = { A: 0, B: 1, C: 2, D: 3 };
    const colIndex = colMap[(column || 'A').toUpperCase()] ?? 0;

    // gviz endpoint を使いタイムスタンプで強制再取得
    const baseUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GID}`;
    const url = `${baseUrl}&t=${Date.now()}`;
    console.log('fetching sheet url=', url, 'column=', column);
    const res = await fetch(url, {
      method: 'GET',
      cache: 'no-store',
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        Pragma: 'no-cache'
      }
    });

    if (!res.ok) throw new Error('スプレッドシート取得失敗: ' + res.status);

    const text = await res.text();
    console.log('loadItemsFromSheet: fetched length=', text.length);
    console.log('loadItemsFromSheet: sample=', text.slice(0, 500).replace(/\n/g,'\\n'));

    const rows = text.split(/\r?\n/);

    // 安全なCSVパーサ：先頭から必要な列だけ抽出（引用符と "" エスケープ対応）
    function parseColumnFromCsvLine(line, index) {
      let inQuotes = false;
      let cur = '';
      let col = 0;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          // "" は1つの " として扱う
          if (inQuotes && line[i + 1] === '"') {
            cur += '"';
            i++; // skip escaped quote
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          if (col === index) return cur.trim();
          col++;
          cur = '';
          // 早期終了：必要列を超えたら空で返す
          if (col > index) return '';
        } else {
          cur += ch;
        }
      }
      // 最後のカラム
      if (col === index) return cur.trim();
      return '';
    }

    // 各行から指定列を取り出し、空行は除去
    items = [];
    for (let i = 0; i < rows.length; i++) {
      const raw = rows[i].trim();
      if (!raw) continue;
      try {
        const val = parseColumnFromCsvLine(raw, colIndex);
        if (val && val.length > 0) items.push(val);
      } catch (err) {
        console.error('CSV parse error at line', i + 1, 'len=', raw.length, err);
      }
    }

    console.log('loadItemsFromSheet: items =', items);

    // items.length に合わせて一周（0〜360°）を等分した虹色を生成
    const n = Math.max(1, items.length);
    colors = Array.from({ length: n }, (_, j) => {
      const hue = Math.round((j / n) * 360);
      return `hsl(${hue}, 75%, 55%)`; // 彩度/明度は必要に応じて調整
    });

    // 描画（読み込み後に初回描画）
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawRoulette();
  } catch (e) {
    console.error('loadItemsFromSheet error:', e);
    // フォールバックの項目
    items = [
      "足足頭頭25m","世界逆一周","3タッチ回転3回","胸キャッチ2回","JUMPトラップ5m x 5回",
      "アラウンドザワールド","インインアウトアウト 10周","右肩 6回","アウト乗せ 3回","背中キャッチ 2回",
      "右ちょん10m","頭のみ10m","足乗せ両足背中キャッチ","足足胸JUMP 25m","たまごちゃん 3m",
      "足足肩シュート","ももダッシュ25m","ショルダーロール","そうまリフティング 25m","地面バウンド3種類"
    ];
    // フォールバックでも items.length に合わせて色を生成
    const n2 = Math.max(1, items.length);
    colors = Array.from({ length: n2 }, (_, j) => {
      const hue = Math.round((j / n2) * 360);
      return `hsl(${hue}, 75%, 55%)`;
    });
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawRoulette();
  }
}

// ====== 音声設定 ======
const spinAudio = document.getElementById('spin-audio'); // 回転中の音
const winAudio1 = document.getElementById('win-audio1'); // 当たり音1（80%）
const winAudio2 = document.getElementById('win-audio2'); // 当たり音2（10%）
const winAudio3 = document.getElementById('win-audio3'); // 当たり音3（10%）

// ====== ルーレット描画関数 ======
function drawRoulette() {
  const arc = (2 * Math.PI) / items.length;
  // 6時方向（下）を0ラジアンにする
  const base = angle;
  for (let i = 0; i < items.length; i++) {
    ctx.beginPath();
    ctx.moveTo(500, 500);
    ctx.fillStyle = colors[i];
    ctx.arc(500, 500, 500, base + i * arc, base + (i + 1) * arc);
    ctx.fill();

    // 文字の描画
    ctx.save();
    ctx.translate(500, 500);
    ctx.rotate(base + (i + 0.5) * arc);
    ctx.fillStyle = "#000";
    ctx.textAlign = "right";
    ctx.font = "32px sans-serif";
    ctx.fillText(items[i], 490, 10);
    ctx.restore();
  }
}

function getResultItem() {
  const arc = (2 * Math.PI) / items.length;
  // 6時方向（下）はcanvas基準でMath.PI/2ラジアン
  // 現在のangle分だけ回転しているので、実際の6時方向の角度は
  // (Math.PI/2 - angle) を 0～2πに正規化
  let pointer = (Math.PI / 2 - angle + 2 * Math.PI) % (2 * Math.PI);

  // どの扇形に含まれるか判定
  for (let i = 0; i < items.length; i++) {
    let start = (i * arc) % (2 * Math.PI);
    let end = ((i + 1) * arc) % (2 * Math.PI);
    // 扇形が0をまたぐ場合も考慮
    if (start < end) {
      if (pointer >= start && pointer < end) return items[i];
    } else {
      if (pointer >= start || pointer < end) return items[i];
    }
  }
  // 念のため
  return items[0];
}

// ====== ルーレット回転処理 ======
let spinning = false; // 回転中フラグ

function spinRoulette() {
  if (spinning) return; // 連打防止
  spinning = true;
  document.getElementById('spin').disabled = true; // ボタン無効化

  // 回転音を再生
  spinAudio.currentTime = 0;
  spinAudio.play();

  // 回転音の長さ（秒）を取得
  const spinDuration = spinAudio.duration || 2; // durationが0の場合は2秒に仮設定

  // アニメーション設定
  const fps = 60;
  const totalFrames = Math.floor(spinDuration * fps);
  let currentFrame = 0;
  const startAngle = angle;
  // 最終的にランダムな位置で止める
  const endAngle = startAngle + Math.PI * 4 + Math.random() * 2 * Math.PI; // 4回転＋ランダム

  const interval = setInterval(() => {
    currentFrame++;
    // イージングで減速
    const t = currentFrame / totalFrames;
    // easeOutCubic
    const eased = 1 - Math.pow(1 - t, 3);
    angle = startAngle + (endAngle - startAngle) * eased;

    ctx.clearRect(0, 0, 1000, 1000);
    drawRoulette();

    if (currentFrame >= totalFrames) {
      clearInterval(interval);
      spinAudio.pause();
      spinAudio.currentTime = 0;

      // ランダムで当選音を選択
      const r = Math.random();
      if (r < 0.7) {
        winAudio1.currentTime = 0;
        winAudio1.play();
      } else if (r < 0.85) {
        winAudio2.currentTime = 0;
        winAudio2.play();
      } else {
        winAudio3.currentTime = 0;
        winAudio3.play();
      }

      spinning = false;
      document.getElementById('spin').disabled = false;

      // 角度を0～2πに正規化
      angle = (angle % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);

      // 当選項目を表示
      const resultItem = getResultItem();
      document.getElementById('result').textContent = resultItem;
    }
  }, 1000 / fps);
}

// ====== 初期描画 ======
// drawRoulette();
loadItemsFromSheet();

let audioUnlocked = false;

document.getElementById('spin').addEventListener('click', async function() {
  if (!audioUnlocked) {
    // win系だけプリロード（無音再生）
    await Promise.all([winAudio1, winAudio2, winAudio3].map(audio => {
      return new Promise(resolve => {
        try {
          audio.muted = true;
          audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
            audio.muted = false;
            resolve();
          }).catch(() => resolve());
        } catch(e) { resolve(); }
      });
    }));
    audioUnlocked = true;
  }

  document.getElementById('result').textContent = ""; // 回すたびにリセット
  spinRoulette();
});

// ボタンで列指定して読み込む（左から A,B,C,D）
document.getElementById('btn-shoot').addEventListener('click', () => loadItemsFromSheet('A'));
document.getElementById('btn-juggle').addEventListener('click', () => loadItemsFromSheet('B'));
document.getElementById('btn-tech').addEventListener('click', () => loadItemsFromSheet('C'));
document.getElementById('btn-beginner').addEventListener('click', () => loadItemsFromSheet('D'));

// 初回は毎回 A 列を表示
loadItemsFromSheet('A');
</script>

<script>
// DOM が準備できたらボタンのクラスを正しく再付与して強制リフロー
window.addEventListener('DOMContentLoaded', () => {
  // action ボタン群は action-btn のみを維持（rich-btn は削除）
  document.querySelectorAll('.action-btn').forEach(b => {
    b.classList.remove('rich-btn');
    if (!b.classList.contains('action-btn')) b.classList.add('action-btn');
    void b.offsetWidth; // 強制リフロー
  });

  // spin ボタンは rich-btn のみを維持
  const spinBtn = document.getElementById('spin');
  if (spinBtn) {
    spinBtn.classList.remove('action-btn');
    if (!spinBtn.classList.contains('rich-btn')) spinBtn.classList.add('rich-btn');
    void spinBtn.offsetWidth;
  }

  // フォント読み込み後にルーレットを再描画（必要なら）
  if (document.fonts) {
    document.fonts.ready.then(() => {
      if (typeof drawRoulette === 'function') drawRoulette();
    });
  } else {
    if (typeof drawRoulette === 'function') drawRoulette();
  }
});
</script>
</body>
</html>