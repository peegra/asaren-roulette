<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="center-container">
    <div class="canvas-area">
      <canvas id="canvas" width="1000" height="1000"></canvas>
    </div>
    <div id="arrow">&#x25B2;</div>
    <div id="result"></div>
    <button id="spin" class="rich-btn">
      <span class="btn-text">ğŸ² å›ã™ï¼</span>
    </button>
    <audio id="spin-audio" src="spin.mp3"></audio>
    <audio id="win-audio" src="win.mp3"></audio>
  </div>
  <!-- LINE LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
// ====== LIFF åˆæœŸåŒ– ======
const liffId = "YOUR_LIFF_ID"; // ã“ã“ã«LIFF IDã‚’å…¥ã‚Œã‚‹

// LIFFã‚’åˆæœŸåŒ–ã—ã¦ã€æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
liff.init({ liffId }).then(() => {
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: window.location.href });
  }
});

// ====== ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆè¨­å®š ======
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®é …ç›®ã¨è‰²
const items = [
  "è¶³è¶³é ­é ­25m","ä¸–ç•Œé€†ä¸€å‘¨","3ã‚¿ãƒƒãƒå›è»¢3å›","èƒ¸ã‚­ãƒ£ãƒƒãƒ2å›","JUMPãƒˆãƒ©ãƒƒãƒ—5m x 5å›",
  "ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¶ãƒ¯ãƒ¼ãƒ«ãƒ‰","ã‚¤ãƒ³ã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã‚¢ã‚¦ãƒˆ 10å‘¨","å³è‚© 6å›","ã‚¢ã‚¦ãƒˆä¹—ã› 3å›","èƒŒä¸­ã‚­ãƒ£ãƒƒãƒ 2å›",
  "å³ã¡ã‚‡ã‚“10m","é ­ã®ã¿10m","è¶³ä¹—ã›ä¸¡è¶³èƒŒä¸­ã‚­ãƒ£ãƒƒãƒ","è¶³è¶³èƒ¸JUMP 25m","ãŸã¾ã”ã¡ã‚ƒã‚“ 3m",
  "è¶³è¶³è‚©ã‚·ãƒ¥ãƒ¼ãƒˆ","ã‚‚ã‚‚ãƒ€ãƒƒã‚·ãƒ¥25m","ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ­ãƒ¼ãƒ«","ãã†ã¾ãƒªãƒ•ãƒ†ã‚£ãƒ³ã‚° 25m","ã¤ã¾ã•ããƒ€ãƒƒã‚·ãƒ¥ 25m"
];
const colors = [
  "#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF",
  "#FF9F40","#FF6384","#36A2EB","#FFCE56","#4BC0C0",
  "#9966FF","#FF9F40","#FF6384","#36A2EB","#FFCE56",
  "#4BC0C0","#9966FF","#FF9F40","#FF6384","#36A2EB"
];
let angle = 0; // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®åˆæœŸè§’åº¦

// ====== éŸ³å£°è¨­å®š ======
const spinAudio = document.getElementById('spin-audio'); // å›è»¢ä¸­ã®éŸ³
const winAudio = document.getElementById('win-audio');   // å½“ãŸã‚Šã®éŸ³

// ====== ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæç”»é–¢æ•° ======
function drawRoulette() {
  const arc = (2 * Math.PI) / items.length;
  // 6æ™‚æ–¹å‘ï¼ˆä¸‹ï¼‰ã‚’0ãƒ©ã‚¸ã‚¢ãƒ³ã«ã™ã‚‹
  const base = angle;
  for (let i = 0; i < items.length; i++) {
    ctx.beginPath();
    ctx.moveTo(500, 500);
    ctx.fillStyle = colors[i];
    ctx.arc(500, 500, 500, base + i * arc, base + (i + 1) * arc);
    ctx.fill();

    // æ–‡å­—ã®æç”»
    ctx.save();
    ctx.translate(500, 500);
    ctx.rotate(base + (i + 0.5) * arc);
    ctx.fillStyle = "#000";
    ctx.textAlign = "right";
    ctx.font = "32px sans-serif";
    ctx.fillText(items[i], 490, 10);
    ctx.restore();
  }
}

function getResultItem() {
  const arc = (2 * Math.PI) / items.length;
  // 6æ™‚æ–¹å‘ï¼ˆä¸‹ï¼‰ã¯canvasåŸºæº–ã§Math.PI/2ãƒ©ã‚¸ã‚¢ãƒ³
  // ç¾åœ¨ã®angleåˆ†ã ã‘å›è»¢ã—ã¦ã„ã‚‹ã®ã§ã€å®Ÿéš›ã®6æ™‚æ–¹å‘ã®è§’åº¦ã¯
  // (Math.PI/2 - angle) ã‚’ 0ï½2Ï€ã«æ­£è¦åŒ–
  let pointer = (Math.PI / 2 - angle + 2 * Math.PI) % (2 * Math.PI);

  // ã©ã®æ‰‡å½¢ã«å«ã¾ã‚Œã‚‹ã‹åˆ¤å®š
  for (let i = 0; i < items.length; i++) {
    let start = (i * arc) % (2 * Math.PI);
    let end = ((i + 1) * arc) % (2 * Math.PI);
    // æ‰‡å½¢ãŒ0ã‚’ã¾ãŸãå ´åˆã‚‚è€ƒæ…®
    if (start < end) {
      if (pointer >= start && pointer < end) return items[i];
    } else {
      if (pointer >= start || pointer < end) return items[i];
    }
  }
  // å¿µã®ãŸã‚
  return items[0];
}

// ====== ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢å‡¦ç† ======
let spinning = false; // å›è»¢ä¸­ãƒ•ãƒ©ã‚°

function spinRoulette() {
  if (spinning) return; // é€£æ‰“é˜²æ­¢
  spinning = true;
  document.getElementById('spin').disabled = true; // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–

  // å›è»¢éŸ³ã‚’å†ç”Ÿ
  spinAudio.currentTime = 0;
  spinAudio.play();

  // å›è»¢éŸ³ã®é•·ã•ï¼ˆç§’ï¼‰ã‚’å–å¾—
  const spinDuration = spinAudio.duration || 2; // durationãŒ0ã®å ´åˆã¯2ç§’ã«ä»®è¨­å®š

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  const fps = 60;
  const totalFrames = Math.floor(spinDuration * fps);
  let currentFrame = 0;
  const startAngle = angle;
  // æœ€çµ‚çš„ã«ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã§æ­¢ã‚ã‚‹
  const endAngle = startAngle + Math.PI * 4 + Math.random() * 2 * Math.PI; // 4å›è»¢ï¼‹ãƒ©ãƒ³ãƒ€ãƒ 

  const interval = setInterval(() => {
    currentFrame++;
    // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°ã§æ¸›é€Ÿ
    const t = currentFrame / totalFrames;
    // easeOutCubic
    const eased = 1 - Math.pow(1 - t, 3);
    angle = startAngle + (endAngle - startAngle) * eased;

    ctx.clearRect(0, 0, 1000, 1000);
    drawRoulette();

    if (currentFrame >= totalFrames) {
      clearInterval(interval);
      spinAudio.pause();
      spinAudio.currentTime = 0;
      winAudio.currentTime = 0;
      winAudio.play();
      spinning = false;
      document.getElementById('spin').disabled = false;

      // è§’åº¦ã‚’0ï½2Ï€ã«æ­£è¦åŒ–
      angle = (angle % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);

      // å½“é¸é …ç›®ã‚’è¡¨ç¤º
      const resultItem = getResultItem();
      document.getElementById('result').textContent = resultItem;
    }
  }, 1000 / fps);
}

// ====== åˆæœŸæç”» ======
drawRoulette();
document.getElementById('spin').addEventListener('click', function() {
  document.getElementById('result').textContent = ""; // å›ã™ãŸã³ã«ãƒªã‚»ãƒƒãƒˆ
  spinRoulette();
});
</script>
</body>
</html>